# MicroCloud Demo Project

This project contains a script to automate the setup of a MicroCloud environment on FIPS enabled hosts using LXD virtual machines (VMs). The script initializes storage, configures networks, and sets up VMs using cloud-init, making the deployment quick and easy.

## Prerequisites

Before running the script, ensure that the following components are installed and configured on your system:

#### 1. **LXD (version 5.0 or later)**

- To install LXD, use the `snap` command.

```bash
sudo snap install lxd
```

- After installation, initialize LXD with the `lxd init` command and allocate at least 40 GiB for the loop device storage.

```bsah
lxd init
```

#### 2. **ZFS (for storage pool management)**

- On Ubuntu, install ZFS by updating your package list and installing `zfsutils-linux`.

```bsah
sudo apt update
sudo apt install zfsutils-linux
```

#### 3. **Bash Shell**

- Ensure you have a Bash shell installed. You can check your Bash version to verify it is installed. Most Linux distributions come with Bash pre-installed.

You can verify it by running:

```bsah
bash --version
```

#### 4. **Certificates for LXD UI Login (Optional)**

- Generate both `.crt` and `.pem` files for secure login to the LXD UI using OpenSSL.

```bash
mkdir certs
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -out lxd-ui.crt
```

- Alternatively, certificates can be generated from the LXD UI after the setup is complete.

## Project Structure

- **`config.sh`**: Configuration file containing environment-specific variables such as storage pool and network names.
- **`certs/`**: Directory containing SSL certificates for the LXD UI (`lxd-ui.crt` and `lxd-ui.pfx`). (OPTIONAL: Can be generated from the UI later)
- **`cleanup.sh`**: Script for cleaning up the MicroCloud environment, removing storage, networks, and VMs.
- **`my-microcloud-init.yaml`**: YAML configuration file generated by the script for initializing the MicroCloud.
- **`setup.sh`**: Main setup script that automates the creation of storage, networks, and VMs, and initializes the MicroCloud.

## Usage

### Step 0: Clone the repo

```bash
git clone https://github.com/Adithya-Rajendran/microcloud-demo
```

### Step 1: Configure Environment

Update the `config.sh` file with your environment-specific settings.
Ensure the following are set:

- Storage Pool Name
- Network Name
- Ubuntu Pro Token

### Step 2: Run the Setup Script

To set up the MicroCloud environment, run the `setup.sh` script:

```bash
bash setup.sh
```

#### What the Script Does

1. **Storage and Volume Creation:**

    - Creates a ZFS storage pool if it doesn't already exist.
    - Creates local and remote storage volumes.

2. **Network Configuration:**

    - Sets up the required network using LXD.

3. **VM Initialization:**

    - Initializes VMs (micro1, micro2, micro3) with cloud-init configurations.
    - Configures the network and storage for each VM.

4. **MicroCloud Initialization:**

    - Generates a `my-microcloud-init.yaml` file based on the configured IPs and network settings.
    - Pushes the YAML file to the primary VM (micro1) and initializes the MicroCloud using the `microcloud init --preseed` command.

## Get the IP post install

```bash
lxc exec micro1 -- bash -c "echo \"Access Microcloud UI: \$(lxc cluster list | grep -m 1 -oP 'https://\\S+')\""
```

## Clean Up

To remove the MicroCloud setup, you can run the cleanup.sh script, which will remove all created resources (VMs, storage, networks).

```bash
bash cleanup.sh
```
